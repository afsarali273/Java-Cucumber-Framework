<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cucumber Hooks - Sands Automation Framework</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <button class="mobile-menu-btn" id="mobile-menu-btn">â˜°</button>
  
  <div class="container">
    <aside class="sidebar">
      <div class="sidebar-header">
        <h1>ðŸš€ Sands Framework</h1>
        <p>Enterprise Automation</p>
      </div>
      <nav>
        <ul class="nav-menu">
          <li class="nav-item"><a href="index.html" class="nav-link"><i class="fas fa-home"></i>Home</a></li>
          <li class="nav-item"><a href="getting-started.html" class="nav-link"><i class="fas fa-rocket"></i>Getting Started</a></li>
          <li class="nav-item"><a href="architecture.html" class="nav-link"><i class="fas fa-sitemap"></i>Architecture</a></li>
          <li class="nav-item"><a href="web-automation.html" class="nav-link"><i class="fas fa-globe"></i>Web Automation</a></li>
          <li class="nav-item"><a href="api-automation.html" class="nav-link"><i class="fas fa-code"></i>API Automation</a></li>
          <li class="nav-item"><a href="mobile-automation.html" class="nav-link"><i class="fas fa-mobile-alt"></i>Mobile Automation</a></li>
          <li class="nav-item"><a href="desktop-automation.html" class="nav-link"><i class="fas fa-desktop"></i>Desktop Automation</a></li>
          <li class="nav-item"><a href="configuration.html" class="nav-link"><i class="fas fa-cog"></i>Configuration</a></li>
          <li class="nav-item"><a href="hooks.html" class="nav-link"><i class="fas fa-link"></i>Hooks</a></li>
          <li class="nav-item"><a href="reporting.html" class="nav-link"><i class="fas fa-chart-bar"></i>Reporting</a></li>
          <li class="nav-item"><a href="utilities.html" class="nav-link"><i class="fas fa-tools"></i>Utilities</a></li>
          <li class="nav-item"><a href="examples.html" class="nav-link"><i class="fas fa-code-branch"></i>Examples</a></li>
          <li class="nav-item"><a href="api-reference.html" class="nav-link"><i class="fas fa-book"></i>API Reference</a></li>
        </ul>
      </nav>
    </aside>

    <main class="main-content">
      <header class="header">
        <h1>Cucumber Hooks</h1>
        <div class="header-actions">
          <input type="text" id="search-box" class="search-box" placeholder="Search...">
          <button id="theme-toggle" class="theme-toggle">ðŸŒ™</button>
        </div>
      </header>

      <section class="section">
        <h2>Overview</h2>
        <p>Cucumber Hooks provide lifecycle management for test execution. The framework implements comprehensive hooks for setup, teardown, reporting, and resource management.</p>
        
        <div class="alert alert-info">
          <strong>Location:</strong> <code>com.automation.core.commonSteps.CucumberHooks</code>
        </div>
      </section>

      <section class="section">
        <h2>Hook Execution Flow</h2>
        <pre><code>@BeforeAll (Suite Level - Once)
    â†“
@Before (Scenario Level - Each Scenario)
    â†“
Scenario Steps Execution
    â†“
@After (Scenario Level - Each Scenario)
    â†“
@AfterAll (Suite Level - Once)</code></pre>
      </section>

      <section class="section">
        <h2>@BeforeAll - Suite Initialization</h2>
        <p>Executes once before all scenarios in the test suite.</p>
        
        <pre><code>@BeforeAll
public static void beforeAll() {
    ExtentReporter.initReports();
    ColoredLogger.header("TEST SUITE STARTED");
    UnifiedLogger.info("Initializing framework configuration...");
    ConfigManager.getInstance(); // Initialize configuration
}</code></pre>

        <h3>What It Does:</h3>
        <ul>
          <li>âœ… Initializes ExtentReports</li>
          <li>âœ… Displays colored console header</li>
          <li>âœ… Loads framework configuration</li>
          <li>âœ… Sets up suite-level resources</li>
        </ul>
      </section>

      <section class="section">
        <h2>@Before - Scenario Setup</h2>
        <p>Executes before each scenario. Initializes drivers/clients based on scenario tags.</p>
        
        <pre><code>@Before
public void beforeScenario(Scenario scenario) {
    String scenarioName = scenario.getName();
    Set&lt;String&gt; tags = new HashSet&lt;&gt;(scenario.getSourceTagNames());

    ExtentReporter.startTest(scenarioName);
    CustomReporter.startTest(scenarioName);

    // Assign category based on tags
    assignCategory(tags);

    UnifiedLogger.info("Starting Scenario: " + scenarioName);

    // Initialize drivers or clients based on tag
    if (tags.contains("@UI") || tags.contains("@Mobile") || tags.contains("@Desktop")) {
        DriverManager.initializeDriver();
    } else if (tags.contains("@API")) {
        APIClient.initializeAPIClient();
    }
}</code></pre>

        <h3>What It Does:</h3>
        <ul>
          <li>âœ… Starts test in ExtentReports and CustomReporter</li>
          <li>âœ… Assigns category based on tags (@UI, @API, @Mobile, @Desktop)</li>
          <li>âœ… Logs scenario start</li>
          <li>âœ… Initializes appropriate driver/client based on tags</li>
        </ul>

        <h3>Tag-Based Initialization</h3>
        <table>
          <thead>
            <tr>
              <th>Tag</th>
              <th>Action</th>
              <th>What Gets Initialized</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>@UI</code></td>
              <td>DriverManager.initializeDriver()</td>
              <td>Selenium WebDriver or Playwright Page</td>
            </tr>
            <tr>
              <td><code>@API</code></td>
              <td>APIClient.initializeAPIClient()</td>
              <td>RestAssured RequestSpecification</td>
            </tr>
            <tr>
              <td><code>@Mobile</code></td>
              <td>DriverManager.initializeDriver()</td>
              <td>Appium Driver (Android/iOS)</td>
            </tr>
            <tr>
              <td><code>@Desktop</code></td>
              <td>DriverManager.initializeDriver()</td>
              <td>WinAppDriver (Windows Desktop)</td>
            </tr>
          </tbody>
        </table>
      </section>

      <section class="section">
        <h2>@After - Scenario Cleanup</h2>
        <p>Executes after each scenario. Handles failures, captures screenshots, and cleans up resources.</p>
        
        <pre><code>@After
public void afterScenario(Scenario scenario) throws IOException {
    String scenarioName = scenario.getName();
    boolean isFailed = scenario.isFailed();

    try {
        if (isFailed) {
            // Get failure details
            String failureDetails = getFailureDetails(scenario);
            if (failureDetails != null && !failureDetails.isEmpty()) {
                UnifiedLogger.fail(scenarioName + " - Failed\\n" + failureDetails);
                ExtentReporter.logFail("Failure Reason:\\n" + failureDetails);
                CustomReporter.logFail("Failure Reason: " + failureDetails);
            } else {
                UnifiedLogger.fail(scenarioName + " - Failed");
            }
            handleFailureScreenshot(scenario);
        } else {
            UnifiedLogger.pass(scenarioName + " - Passed");
        }
    } catch (Exception e) {
        UnifiedLogger.fail("Error during afterScenario: " + e.getMessage());
    } finally {
        // Cleanup and finalize reports
        ExtentReporter.endTest();
        CustomReporter.endTest();
        DriverManager.quitDriver();
        APIClient.clearRequestSpec();
        
        // Clear scenario context to prevent memory leaks
        ScenarioContext.reset();
        
        UnifiedLogger.info("Completed Scenario: " + scenarioName + " | Status: " + scenario.getStatus());
    }
}</code></pre>

        <h3>What It Does:</h3>
        <ul>
          <li>âœ… Checks if scenario failed</li>
          <li>âœ… Extracts failure details (exception type, message, stack trace)</li>
          <li>âœ… Logs failure to all reporters (UnifiedLogger, ExtentReporter, CustomReporter)</li>
          <li>âœ… Captures screenshot on failure (for UI/Mobile/Desktop tests)</li>
          <li>âœ… Logs pass status for successful scenarios</li>
          <li>âœ… Ends test in all reporters</li>
          <li>âœ… Quits driver/clears API client</li>
          <li>âœ… Resets ScenarioContext to prevent memory leaks</li>
          <li>âœ… Logs scenario completion status</li>
        </ul>
      </section>

      <section class="section">
        <h2>Failure Details Extraction</h2>
        <p>Uses reflection to extract detailed failure information from Cucumber Scenario object.</p>
        
        <pre><code>private String getFailureDetails(Scenario scenario) {
    try {
        java.lang.reflect.Field delegateField = scenario.getClass().getDeclaredField("delegate");
        delegateField.setAccessible(true);
        Object delegate = delegateField.get(scenario);
        
        java.lang.reflect.Method getErrorMethod = delegate.getClass().getMethod("getError");
        Throwable error = (Throwable) getErrorMethod.invoke(delegate);
        
        if (error != null) {
            StringBuilder details = new StringBuilder();
            details.append(error.getClass().getSimpleName()).append(": ").append(error.getMessage());
            
            StackTraceElement[] stackTrace = error.getStackTrace();
            if (stackTrace != null && stackTrace.length > 0) {
                details.append("\\n");
                int limit = Math.min(5, stackTrace.length);
                for (int i = 0; i < limit; i++) {
                    details.append("  at ").append(stackTrace[i].toString()).append("\\n");
                }
            }
            return details.toString();
        }
    } catch (Exception e) {
        // Reflection failed, return null
    }
    return null;
}</code></pre>

        <h3>Output Format:</h3>
        <pre><code>AssertionError: Expected 200 but got 404
  at com.automation.stepdefinitions.APISteps.validateStatus(APISteps.java:45)
  at âœ½.response status code should be 200(api.feature:12)
  at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
  at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
  at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</code></pre>
      </section>

      <section class="section">
        <h2>Screenshot on Failure</h2>
        <p>Automatically captures and attaches screenshots to all reports when a scenario fails.</p>
        
        <pre><code>private static void handleFailureScreenshot(Scenario scenario) throws IOException {
    ConfigManager config = ConfigManager.getInstance();
    Set&lt;String&gt; tags = new HashSet&lt;&gt;(scenario.getSourceTagNames());

    if (config.getBooleanProperty("screenshot.on.failure", true) && !tags.contains("@API")) {
        String screenshotPath = ScreenshotUtil.captureScreenshot(scenario.getName());
        if (screenshotPath != null) {
            byte[] screenshot = Files.readAllBytes(Paths.get(screenshotPath));

            // Attach to Cucumber
            scenario.attach(screenshot, "image/png", "Screenshot");

            // Attach to Allure
            io.qameta.allure.Allure.addAttachment(
                    "Screenshot on Failure", "image/png",
                    new ByteArrayInputStream(screenshot), "png"
            );

            // Attach to ExtentReport
            ExtentReporter.attachScreenshot(screenshotPath);
        }
    }
}</code></pre>

        <h3>Screenshot Behavior:</h3>
        <ul>
          <li>âœ… Only captures for UI/Mobile/Desktop tests (skips @API)</li>
          <li>âœ… Controlled by <code>screenshot.on.failure</code> property</li>
          <li>âœ… Attaches to Cucumber HTML report</li>
          <li>âœ… Attaches to Allure report</li>
          <li>âœ… Attaches to ExtentReport</li>
          <li>âœ… Saves to file system at <code>test-output/screenshots/</code></li>
        </ul>
      </section>

      <section class="section">
        <h2>@AfterAll - Suite Cleanup</h2>
        <p>Executes once after all scenarios complete. Generates reports and cleans up suite-level resources.</p>
        
        <pre><code>@AfterAll
public static void afterAll() {
    try {
        if (ConfigManager.isPlaywright()) {
            DriverManager.closePlaywright();
        }
    } catch (Exception e) {
        UnifiedLogger.error("Error closing Playwright: ", e);
    } finally {
        ExtentReporter.flushReports();
        CustomReporter.generateReport();
        generateAllureReport();
        ColoredLogger.header("TEST SUITE COMPLETED");
    }
}</code></pre>

        <h3>What It Does:</h3>
        <ul>
          <li>âœ… Closes Playwright browser context (if used)</li>
          <li>âœ… Flushes ExtentReports to disk</li>
          <li>âœ… Generates CustomReporter HTML</li>
          <li>âœ… Generates Allure report</li>
          <li>âœ… Displays suite completion header</li>
        </ul>
      </section>

      <section class="section">
        <h2>Allure Report Generation</h2>
        <p>Automatically generates Allure report after test suite completion.</p>
        
        <pre><code>private static void generateAllureReport() {
    try {
        UnifiedLogger.info("Generating Allure report...");

        ProcessBuilder pb = new ProcessBuilder("mvn", "allure:report");
        pb.directory(new File(System.getProperty("user.dir")));
        pb.redirectErrorStream(true);

        Process process = pb.start();
        BufferedReader reader = new BufferedReader(new InputStreamReader(process.getInputStream()));
        String line;

        while ((line = reader.readLine()) != null) {
            if (line.contains("BUILD SUCCESS") || line.contains("Report successfully generated")) {
                UnifiedLogger.info(line);
            }
        }

        int exitCode = process.waitFor();
        if (exitCode == 0) {
            UnifiedLogger.info("Allure report generated at: test-output/allure");
            UnifiedLogger.info("To view the report, run: mvn allure:serve");
        }
    } catch (Exception e) {
        UnifiedLogger.warn("Allure report generation skipped: " + e.getMessage());
    }
}</code></pre>

        <h3>Report Generation:</h3>
        <ul>
          <li>âœ… Executes <code>mvn allure:report</code> command</li>
          <li>âœ… Logs generation progress</li>
          <li>âœ… Reports location: <code>test-output/allure</code></li>
          <li>âœ… Gracefully handles failures (logs warning)</li>
        </ul>
      </section>

      <section class="section">
        <h2>Category Assignment</h2>
        <p>Assigns test categories in ExtentReports based on scenario tags.</p>
        
        <pre><code>private static void assignCategory(Set&lt;String&gt; tags) {
    if (tags.contains("@UI")) ExtentReporter.assignCategory("UI");
    if (tags.contains("@API")) ExtentReporter.assignCategory("API");
    if (tags.contains("@Mobile")) ExtentReporter.assignCategory("Mobile");
    if (tags.contains("@Desktop")) ExtentReporter.assignCategory("Desktop");
}</code></pre>

        <h3>Categories in ExtentReport:</h3>
        <div class="card-grid">
          <div class="card">
            <h3>@UI</h3>
            <p>Web automation tests</p>
            <span class="badge badge-primary">Category: UI</span>
          </div>
          <div class="card">
            <h3>@API</h3>
            <p>REST/SOAP API tests</p>
            <span class="badge badge-success">Category: API</span>
          </div>
          <div class="card">
            <h3>@Mobile</h3>
            <p>Mobile app tests</p>
            <span class="badge badge-info">Category: Mobile</span>
          </div>
          <div class="card">
            <h3>@Desktop</h3>
            <p>Desktop app tests</p>
            <span class="badge badge-info">Category: Desktop</span>
          </div>
        </div>
      </section>

      <section class="section">
        <h2>Custom Hooks</h2>
        <p>You can create custom hooks for specific scenarios or tags.</p>
        
        <h3>Tag-Specific Hooks</h3>
        <pre><code>public class CustomHooks {
    
    @Before("@Database")
    public void setupDatabase() {
        DatabaseUtils.connect();
        UnifiedLogger.info("Database connection established");
    }
    
    @After("@Database")
    public void cleanupDatabase() {
        DatabaseUtils.disconnect();
        UnifiedLogger.info("Database connection closed");
    }
    
    @Before("@RequiresAuth")
    public void setupAuthentication() {
        String token = AuthService.getToken();
        APIClient.setHeader("Authorization", "Bearer " + token);
        UnifiedLogger.info("Authentication token set");
    }
}</code></pre>

        <h3>Hook Execution Order</h3>
        <pre><code>@Before(order = 0)  // Executes first
public void highPrioritySetup() {
    // Critical setup
}

@Before(order = 1)  // Executes second
public void normalSetup() {
    // Normal setup
}

@After(order = 0)   // Executes first (cleanup in reverse)
public void normalCleanup() {
    // Normal cleanup
}

@After(order = 1)   // Executes last
public void lowPriorityCleanup() {
    // Final cleanup
}</code></pre>

        <div class="alert alert-info">
          <strong>Order Rules:</strong>
          <ul>
            <li>Lower order number = Higher priority</li>
            <li>@Before: Lower order executes first</li>
            <li>@After: Lower order executes first (reverse of @Before)</li>
            <li>Default order is 10000</li>
          </ul>
        </div>
      </section>

      <section class="section">
        <h2>Hook Configuration</h2>
        
        <h3>Enable/Disable Screenshot on Failure</h3>
        <pre><code># config.properties
screenshot.on.failure=true</code></pre>

        <h3>Configure Screenshot Path</h3>
        <pre><code># config.properties
screenshot.path=test-output/screenshots</code></pre>

        <h3>Configure Report Path</h3>
        <pre><code># config.properties
report.path=test-output/reports</code></pre>
      </section>

      <section class="section">
        <h2>Complete Hook Lifecycle Example</h2>
        <pre><code>// Suite starts
@BeforeAll
    - Initialize ExtentReports
    - Load configuration
    - Display "TEST SUITE STARTED"

// Scenario 1: @UI @Smoke
@Before
    - Start test in reports
    - Assign category: UI
    - Initialize Selenium/Playwright driver
    - Log: "Starting Scenario: Login Test"

// Steps execute...

@After
    - Scenario passed
    - Log: "Login Test - Passed"
    - End test in reports
    - Quit driver
    - Clear API client
    - Reset ScenarioContext
    - Log: "Completed Scenario: Login Test | Status: PASSED"

// Scenario 2: @API
@Before
    - Start test in reports
    - Assign category: API
    - Initialize APIClient
    - Log: "Starting Scenario: Get User API"

// Steps execute... (fails)

@After
    - Scenario failed
    - Extract failure details: "AssertionError: Expected 200 but got 404"
    - Log failure to all reporters
    - No screenshot (API test)
    - End test in reports
    - Clear API client
    - Reset ScenarioContext
    - Log: "Completed Scenario: Get User API | Status: FAILED"

// All scenarios complete
@AfterAll
    - Close Playwright (if used)
    - Flush ExtentReports
    - Generate CustomReporter HTML
    - Generate Allure report
    - Display "TEST SUITE COMPLETED"</code></pre>
      </section>

      <section class="section">
        <h2>Best Practices</h2>
        <ul>
          <li>Use framework hooks for common setup/teardown</li>
          <li>Create custom hooks for specific requirements</li>
          <li>Use order parameter to control execution sequence</li>
          <li>Tag scenarios appropriately (@UI, @API, @Mobile, @Desktop)</li>
          <li>Keep hooks lightweight and fast</li>
          <li>Always cleanup resources in @After hooks</li>
          <li>Use ScenarioContext for data sharing between steps</li>
          <li>Enable screenshot.on.failure for debugging</li>
          <li>Review generated reports after test execution</li>
        </ul>
      </section>

      <footer class="footer">
        <p>&copy; 2025 Sands Automation Framework. Created by <a href="#">Afsar Ali</a></p>
      </footer>
    </main>
  </div>

  <script src="js/main.js"></script>
</body>
</html>
